from django.db import migrations
from django.utils import timezone


def create_initial_content(apps, schema_editor):
    Category = apps.get_model('portal', 'Category')
    Tag = apps.get_model('portal', 'Tag')
    Article = apps.get_model('portal', 'Article')
    User = apps.get_model('auth', 'User')

    categories_data = [
        ('Технологии', 'tehnologii'),
        ('Образование', 'obrazovanie'),
        ('Карьерное развитие', 'karernoe-razvitie'),
        ('Здоровье и комфорт', 'zdorove'),
        ('Городская среда', 'gorodskaya-sreda'),
    ]

    category_map = {}
    for name, slug in categories_data:
        category, _ = Category.objects.get_or_create(name=name, slug=slug)
        category_map[slug] = category

    tags_data = [
        ('Аналитика', 'analitika'),
        ('Data Science', 'data-science'),
        ('EdTech', 'edtech'),
        ('Навыки будущего', 'future-skills'),
        ('Лидерство', 'liderstvo'),
        ('Продуктивность', 'productivity'),
        ('Город', 'city'),
        ('Экология', 'ecology'),
        ('Инициативы', 'iniciativy'),
        ('Инновации', 'innovacii'),
    ]

    tag_map = {}
    for name, slug in tags_data:
        tag, _ = Tag.objects.get_or_create(name=name, slug=slug)
        tag_map[slug] = tag

    editor, _ = User.objects.get_or_create(
        username='editor',
        defaults={
            'first_name': 'Редакция',
            'last_name': 'Портала',
            'email': 'editor@infportal.local',
        },
    )

    articles_data = [
        {
            'title': 'Как компании в России внедряют искусственный интеллект в 2024 году',
            'slug': 'kak-kompanii-v-rossii-vnedryayut-iskusstvennyi-intellekt-v-2024-godu',
            'excerpt': 'Промышленность, ритейл и финансы инвестируют в AI-проекты. Разбираемся, какие подходы работают лучше всего и как оценить эффект.',
            'content': """
Искусственный интеллект перестал быть экспериментом. В крупных компаниях он отвечает за прогнозирование спроса, оптимизацию логистики и автоматизацию клиентских сервисов. Ключ к успеху — выбор конкретных задач, где алгоритмы действительно экономят время специалистов.

Сбор качественных данных остаётся самой трудоёмкой частью проекта. Команды внедряют единые каталоги данных и выстраивают процессы их проверки. Это позволяет избежать перекоса в моделях и быстрее масштабировать решения между подразделениями.

Второе направление — обучение сотрудников. Бизнес создаёт программы повышения цифровой грамотности и разрабатывает внутренние песочницы для тестирования моделей. Так специалисты постепенно осваивают AI-инструменты и находят сценарии для их применения.

Чтобы измерить экономический эффект, компании фиксируют конкретные метрики: сокращение времени обработки заказов, увеличение точности прогнозов, рост удовлетворённости клиентов. Без этих показателей проекты рискуют остаться на уровне пилотов.
            """,
            'category': 'tehnologii',
            'tags': ['analitika', 'data-science', 'innovacii'],
            'days_ago': 2,
            'views': 376,
        },
        {
            'title': 'Как развивать цифровые навыки сотрудников: опыт университетов и корпораций',
            'slug': 'kak-razvivat-cifrovye-navyki-sotrudnikov-opyt-universitetov-i-korporacii',
            'excerpt': 'Компании превращают обучение в непрерывный процесс. Рассказываем, как построить корпоративный университет и не потерять мотивацию сотрудников.',
            'content': """
Корпоративные университеты перестали быть набором лекций. Они трансформируются в экосистемы с практическими кейсами, наставниками и цифровыми тренажёрами. Такой подход повышает вовлечённость: сотрудники сразу видят, как новые навыки применяются на работе.

Университеты внедряют проектные форматы обучения. Команды решают задачи бизнеса, а наставники помогают выбрать инструменты. Благодаря этому теория закрепляется через практику, а результаты можно измерять по показателям проектов.

Сильная мотивация появляется, когда обучение встроено в карьерные треки. Сотрудник понимает, какие компетенции требуются для повышения и какие курсы помогут их развить. Это стимулирует планировать развитие на год вперёд и обсуждать прогресс с руководителем.

Компании также используют EdTech-платформы с адаптивными курсами. Алгоритмы подбирают задания под уровень участника и подсказывают, когда стоит повторить материал. Такой формат помогает быстрее закрыть пробелы в знаниях и сделать обучение персонализированным.
            """,
            'category': 'obrazovanie',
            'tags': ['edtech', 'future-skills', 'productivity'],
            'days_ago': 6,
            'views': 248,
        },
        {
            'title': 'Пять шагов для перехода на руководящую позицию',
            'slug': 'pyat-shagov-dlya-perehoda-na-rukovodyashchuyu-poziciyu',
            'excerpt': 'Практическое руководство, как подготовиться к руководящей роли и не потерять поддержку команды.',
            'content': """
Руководящая позиция начинается с анализа текущей роли. Важно понять, какие процессы вы уже ведёте, какие решения принимаете и как влияет ваша работа на результаты команды. Это позволит сформулировать конкретные зоны роста.

Следующий шаг — развитие управленческих навыков. Полезны курсы по коммуникации, управлению проектами, работе с конфликтами. Дополните их регулярной обратной связью от наставника: внешний взгляд помогает быстрее скорректировать поведение.

Важно заранее договориться с руководителем о расширении зоны ответственности. Можно взять пилотный проект или стать заместителем на время отпусков. Это безопасный способ проверить гипотезы и показать готовность к новой роли.

Не забывайте о поддержке команды. Открыто рассказывайте, зачем нужны изменения, собирайте предложения и демонстрируйте, что принимаете решения прозрачно. Ваша задача — стать связующим звеном между стратегией компании и ежедневной работой сотрудников.
            """,
            'category': 'karernoe-razvitie',
            'tags': ['liderstvo', 'future-skills'],
            'days_ago': 9,
            'views': 189,
        },
        {
            'title': 'Как офисные привычки влияют на здоровье и продуктивность',
            'slug': 'kak-ofisnye-privychki-vliyayut-na-zdorove-i-produktivnost',
            'excerpt': 'Организация рабочего места и короткие перерывы помогают снизить усталость. Делимся научно обоснованными советами.',
            'content': """
Регулярные короткие перерывы снижают уровень стресса и повышают концентрацию. Исследования показывают, что пяти минут достаточно, чтобы переключиться и вернуть внимание к задаче. Главное — использовать паузу на растяжку или прогулку, а не на соцсети.

Освещение тоже влияет на продуктивность. Натуральный свет поддерживает циркадные ритмы, поэтому рабочее место лучше располагать ближе к окну. Если такой возможности нет, выбирайте лампы с тёплым спектром и регулируемой яркостью.

Важен и микроклимат офиса. Оптимальная температура — 22–23 градуса, влажность — около 40%. Эти параметры уменьшают усталость глаз и помогают поддерживать энергию в течение дня.

Не забывайте про движение. Лёгкая зарядка каждый час и прогулки в обеденный перерыв уменьшают риск болей в спине и помогают мозгу быстрее переключаться между задачами.
            """,
            'category': 'zdorove',
            'tags': ['productivity'],
            'days_ago': 4,
            'views': 205,
        },
        {
            'title': 'Городские сообщества как драйвер развития районов',
            'slug': 'gorodskie-soobshchestva-kak-draiver-razvitiya-raionov',
            'excerpt': 'Активные жители помогают модернизировать инфраструктуру и запускать культурные проекты. Приводим успешные примеры.',
            'content': """
Инициативные группы жителей становятся посредниками между горожанами и администрацией. Они формируют запросы, собирают обратную связь и помогают приоритизировать проекты. Такой подход позволяет запускать программы благоустройства, которые действительно востребованы.

Сообщества организуют образовательные и культурные события. В районах появляются лектории, городские мастерские, коворкинги. Это повышает вовлечённость жителей и формирует среду, где люди готовы предлагать идеи и брать ответственность за их реализацию.

Важную роль играет цифровая инфраструктура. Платформы для голосований и обмена новостями делают процессы прозрачными. Жители видят, на что тратятся средства, и могут следить за ходом работ в реальном времени.

Чтобы проекты были устойчивыми, нужны партнёрства с бизнесом и некоммерческими организациями. Вместе проще искать финансирование и привлекать экспертизу. Так район получает комплексное развитие, а жители — возможность влиять на изменения.
            """,
            'category': 'gorodskaya-sreda',
            'tags': ['city', 'iniciativy', 'ecology'],
            'days_ago': 12,
            'views': 162,
        },
        {
            'title': 'Как построить персональную стратегию обучения на год',
            'slug': 'kak-postroit-personalnuyu-strategiyu-obucheniya-na-god',
            'excerpt': 'Разбираем подход, который поможет превратить планы по саморазвитию в понятный календарь и довести обучение до результата.',
            'content': """
Первый шаг — сформулировать карьерные цели на год. Разбейте их на компетенции: что нужно знать, какие навыки развить. Это станет основой образовательного плана и поможет отслеживать прогресс.

Составьте карту источников: курсы, книги, наставники, профессиональные сообщества. Для каждого ресурса определите ожидаемый результат и сроки. Такой подход превращает обучение в проект с чёткими этапами.

Заложите время на практику и обратную связь. После каждого модуля выполните мини-проект или обсудите результаты с коллегой. Это позволит закрепить знания и понять, что ещё требует внимания.

Используйте ежемесячные ретроспективы. Оценивайте, что получилось, а что нужно скорректировать. При необходимости адаптируйте план: главное — сохранять регулярность и не прекращать экспериментировать с форматами обучения.
            """,
            'category': 'obrazovanie',
            'tags': ['future-skills', 'productivity', 'edtech'],
            'days_ago': 1,
            'views': 298,
        },
    ]

    for data in articles_data:
        category = category_map.get(data['category'])
        article, created = Article.objects.get_or_create(
            slug=data['slug'],
            defaults={
                'title': data['title'],
                'excerpt': data['excerpt'],
                'content': data['content'].strip(),
                'category': category,
                'status': 'published',
                'created_at': timezone.now() - timezone.timedelta(days=data['days_ago']),
                'views': data['views'],
                'author': editor,
            },
        )
        if created:
            tags = [tag_map[tag_slug] for tag_slug in data['tags'] if tag_slug in tag_map]
            article.tags.add(*tags)


def delete_initial_content(apps, schema_editor):
    Article = apps.get_model('portal', 'Article')
    Tag = apps.get_model('portal', 'Tag')
    Category = apps.get_model('portal', 'Category')

    article_slugs = [
        'kak-kompanii-v-rossii-vnedryayut-iskusstvennyi-intellekt-v-2024-godu',
        'kak-razvivat-cifrovye-navyki-sotrudnikov-opyt-universitetov-i-korporacii',
        'pyat-shagov-dlya-perehoda-na-rukovodyashchuyu-poziciyu',
        'kak-ofisnye-privychki-vliyayut-na-zdorove-i-produkтивnost',
        'gorodskie-soobshchestva-kak-draiver-razvitiya-raionov',
        'kak-postroit-personalnuyu-strategiyu-obucheniya-na-god',
    ]
    Article.objects.filter(slug__in=article_slugs).delete()

    tag_slugs = [
        'analitika',
        'data-science',
        'edtech',
        'future-skills',
        'liderstvo',
        'productivity',
        'city',
        'ecology',
        'iniciativy',
        'innovacii',
    ]
    Tag.objects.filter(slug__in=tag_slugs).delete()

    category_slugs = [
        'tehnologii',
        'obrazovanie',
        'karernoe-razvitie',
        'zdorove',
        'gorodskaya-sreda',
    ]
    Category.objects.filter(slug__in=category_slugs).delete()


class Migration(migrations.Migration):

    dependencies = [
        ('portal', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(create_initial_content, delete_initial_content),
    ]
