{% extends 'portal/base.html' %}
{% load static %}

{% block page_title %}{{ article.title }} — Информационный портал{% endblock %}
{% block meta_description %}{{ article.excerpt|default:article.content|truncatewords:30 }}{% endblock %}
{% block meta_keywords %}{% for tag in article.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.excerpt|default:article.content|truncatewords:30 }}{% endblock %}
{% block og_image %}{% if article.cover %}{{ request.scheme }}://{{ request.get_host }}{{ article.cover.url }}{% else %}{{ block.super }}{% endif %}{% endblock %}
{% block twitter_title %}{{ article.title }}{% endblock %}
{% block twitter_description %}{{ article.excerpt|default:article.content|truncatewords:30 }}{% endblock %}
{% block twitter_image %}{% if article.cover %}{{ request.scheme }}://{{ request.get_host }}{{ article.cover.url }}{% else %}{{ block.super }}{% endif %}{% endblock %}

{% block hero %}
  <section class="article-hero py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <span class="badge rounded-pill bg-primary-subtle text-primary mb-3">{{ article.category.name|default:'Материал' }}</span>
          <h1 class="display-5 fw-bold mb-4">{{ article.title }}</h1>
          <div class="d-flex flex-wrap gap-3 align-items-center text-muted">
            <span>
              Автор:
              {% if article.author %}
                {% with full_name=article.author.get_full_name %}
                  {{ full_name|default:article.author.username }}
                {% endwith %}
              {% else %}
                Редакция портала
              {% endif %}
            </span>
            <span>·</span>
            <span>{{ article.created_at|date:"d E Y" }}</span>
            <span>·</span>
            <span>{{ article.estimated_read_time }} мин чтения</span>
            <span>·</span>
            <span>Просмотров: {{ article.views }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <article class="article-body card shadow-sm">
        <div class="card-body p-4 p-lg-5">
          {% if article.cover %}
            <img src="{{ article.cover.url }}" class="img-fluid rounded mb-4" alt="Обложка статьи {{ article.title }}">
          {% endif %}
          <div class="article-content">{{ article.get_content_html|safe }}</div>
          <div class="d-flex flex-wrap gap-2 mt-4">
            {% for tag in article.tags.all %}
              <span class="badge bg-light text-secondary border">#{{ tag.name }}</span>
            {% empty %}
              <span class="text-muted">Теги не указаны</span>
            {% endfor %}
          </div>
          <div class="share-box mt-4 p-4 rounded">
            <h3 class="h6 fw-semibold mb-2">Понравилась статья?</h3>
            <p class="text-muted small mb-3">Расскажите коллегам: скопируйте ссылку или поделитесь в соцсетях.</p>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline-primary btn-sm" type="button" data-copy>{{ request.build_absolute_uri }}</button>
              <a class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener" href="https://t.me/share/url?url={{ request.build_absolute_uri|urlencode }}&text={{ article.title|urlencode }}">Telegram</a>
              <a class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener" href="https://vk.com/share.php?url={{ request.build_absolute_uri|urlencode }}">VK</a>
            </div>
          </div>
        </div>
      </article>

      <section class="mt-5" id="comments">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 mb-0">Комментарии{% if comments %} ({{ comments.paginator.count }}){% endif %}</h2>
          <a class="btn btn-primary" href="{% url 'portal:add_comment' article.slug %}">Оставить комментарий</a>
        </div>
        
        {% if comments %}
          {% for comment in comments %}
            <div class="comment-card border rounded-3 p-3 p-md-4 mb-3">
              <div class="d-flex justify-content-between flex-wrap gap-2 mb-2">
                <div class="fw-semibold">{% firstof comment.name comment.author.get_full_name comment.author.username 'Гость' %}</div>
                <small class="text-muted">{{ comment.created_at|date:"d E Y H:i" }}</small>
              </div>
              <div class="text-muted">{{ comment.content|linebreaks }}</div>
            </div>
          {% endfor %}
          
          {% if comments.has_other_pages %}
            <nav aria-label="Пагинация комментариев">
              <ul class="pagination justify-content-center">
                {% if comments.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ comments.previous_page_number }}#comments">Предыдущая</a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">Предыдущая</span>
                  </li>
                {% endif %}
                
                <li class="page-item disabled">
                  <span class="page-link">Страница {{ comments.number }} из {{ comments.paginator.num_pages }}</span>
                </li>
                
                {% if comments.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ comments.next_page_number }}#comments">Следующая</a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">Следующая</span>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <p class="text-muted">Пока никто не оставил комментарий. Будьте первым!</p>
        {% endif %}
      </section>
    </div>

    <aside class="col-lg-4">
      <div class="sticky-top" style="top: 6rem;">
        {% if related_articles %}
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h3 class="h6 fw-semibold mb-3">Другие материалы по теме</h3>
              <ul class="list-unstyled mb-0">
                {% for related in related_articles %}
                  <li class="mb-3">
                    <a class="text-decoration-none" href="{{ related.get_absolute_url }}">{{ related.title }}</a>
                    <div class="text-muted small">{{ related.created_at|date:"d E" }} · {{ related.estimated_read_time }} мин</div>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="h6 fw-semibold mb-3">Обратная связь</h3>
            <p class="text-muted small mb-0">Наши авторы всегда открыты для предложений. Напишите нам, если хотите увидеть на портале новую тему.</p>
            <a class="btn btn-outline-primary btn-sm mt-3" href="mailto:editor@infportal.local">Предложить тему</a>
          </div>
        </div>
      </div>
    </aside>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('click', function (event) {
      if (event.target.matches('[data-copy]')) {
        navigator.clipboard.writeText(event.target.textContent.trim());
        event.target.textContent = 'Ссылка скопирована';
        setTimeout(function () {
          event.target.textContent = '{{ request.build_absolute_uri }}';
        }, 2500);
      }
    });
  </script>
{% endblock %}
